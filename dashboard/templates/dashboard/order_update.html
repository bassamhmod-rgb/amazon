{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ â€“ {{ store.name }}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

     <style>
        body{
            background:#f7f9fc;
            font-family:"Cairo",sans-serif;
            overflow-x:hidden; /* ğŸ”‘ Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§ */
        }

        /* ===== SIDEBAR ===== */
        .sidebar{
            width:230px;
            background:#fff;
            height:100vh;
            position:fixed;
            top:0;
            right:0;
            padding:20px 15px;
            border-left:1px solid #e0e0e0;
            transition:.3s;
            z-index:1000;
        }

        .sidebar a{
            display:block;
            padding:10px 12px;
            margin-bottom:8px;
            color:#333;
            border-radius:8px;
            text-decoration:none;
        }
        .sidebar a:hover{
            background:#e9f2ff;
            color:#0d6efd;
        }

        /* ===== CONTENT ===== */
        .content{
            margin-right:240px;
            padding:20px;
            transition:.3s;
        }

        /* ===== SIDEBAR ARROW ===== */
        #sidebarArrow{
            display:none;
        }

        @media (max-width:768px){
            .sidebar{ right:-260px; }
            .sidebar.active{ right:0; }
            .content{ margin-right:0; }

            #sidebarArrow{
                display:flex;
                position:fixed;
                top:50%;
                right:0;
                transform:translateY(-50%);
                width:26px;
                height:48px;
                background:#1A2A4A;
                color:#fff;
                border-radius:10px 0 0 10px;
                align-items:center;
                justify-content:center;
                font-size:18px;
                cursor:pointer;
                z-index:1001;
                box-shadow:-3px 0 10px rgba(0,0,0,.15);
                user-select:none;
            }
        }

        #searchResults, #customerResults, #supplierResults {
            max-height:200px;
            overflow-y:auto;
            box-shadow:0 4px 6px rgba(0,0,0,0.15);
            display:none;
            background:#fff;
            z-index:1000;
            position:absolute;
            width:100%;
        }

        .list-group-item.active{
            background:#0d6efd;
            color:#fff !important;
        }

        .en-num{
            direction:ltr !important;
            unicode-bidi:plaintext !important;
        }
    /* ===== FIX TABLE ON MOBILE (ORDERS) ===== */
@media (max-width: 768px){

    /* Ø®Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø³Ø­Ø¨ */
    .table-responsive{
        overflow-x:auto;
        -webkit-overflow-scrolling: touch;
    }

    table{
        min-width: 600px; /* ğŸ”‘ ÙŠÙ…Ù†Ø¹ Ø¶ØºØ· Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
    }

    table th,
    table td{
        white-space: nowrap;
        vertical-align: middle;
        text-align: center;
    }

    /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… */
    table input.form-control{
        min-width: 90px;   /* ğŸ”¥ ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø© */
        text-align: center;
        padding: 6px 8px;
    }

    table .price{
        min-width: 100px;
    }

    table .quantity{
        min-width: 80px;
    }

    table .subtotal{
        min-width: 90px;
        display: inline-block;
    }
}

    </style>
</head>

<body>

<!-- Ø³Ù‡Ù… Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± -->
<div id="sidebarArrow">â¯</div>

<!-- Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± -->
{% include "dashboard/sidebar.html" %}

<div class="content">

    <h3 class="mb-4">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù… #{{ order.id }}</h3>

    <!-- Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© -->
    <div class="card p-3 mb-3 shadow-sm border-0">
        <label class="form-label fw-bold">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
        <select id="transaction_type" class="form-select" onchange="toggleFields()">
            <option value="sale" {% if order.transaction_type == 'sale' %}selected{% endif %}>Ø¨ÙŠØ¹</option>
            <option value="purchase" {% if order.transaction_type == 'purchase' %}selected{% endif %}>Ø´Ø±Ø§Ø¡</option>
        </select>
    </div>

    <form method="post">
    {% csrf_token %}

    <input type="hidden" name="transaction_type" id="transaction_type_hidden"
           value="{{ order.transaction_type }}">
    <input type="hidden" name="customer_id" id="customer_id" value="{{ order.customer.id }}">
    <input type="hidden" name="supplier_id" id="supplier_id" value="{{ order.supplier.id }}">

    <!-- Ø¨Ø­Ø« Ù…Ù†ØªØ¬ -->
    <div class="card p-3 mb-3 border-0 shadow-sm">
        <label class="form-label fw-bold">Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬</label>
        <div class="position-relative">
            <input type="text" id="productSearch" class="form-control"
                   placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬..." autocomplete="off">
            <div id="searchResults" class="list-group mt-1"></div>
        </div>
    </div>

    <!-- Ø²Ø¨ÙˆÙ† -->
    <div id="customerBox" class="card p-3 mb-3 border-0 shadow-sm"
         style="{% if order.transaction_type == 'purchase' %}display:none{% endif %}">
        <label class="form-label fw-bold">Ø§Ù„Ø²Ø¨ÙˆÙ†</label>

        <div id="customerSearchContainer" class="position-relative"
             style="{% if order.customer %}display:none{% endif %}">
            <input type="text" id="customerSearch" class="form-control"
                   placeholder="Ø§Ø¨Ø­Ø«..." autocomplete="off">
            <div id="customerResults" class="list-group mt-1"></div>
        </div>

        <div id="selectedCustomerCard"
             class="alert alert-success d-flex justify-content-between align-items-center m-0"
             style="{% if order.customer %}display:flex{% else %}display:none{% endif %}">
            <span id="selectedCustomerName">{{ order.customer }}</span>
            <button type="button" class="btn btn-sm btn-outline-danger bg-white"
                    onclick="removeCustomer()">âŒ</button>
        </div>
    </div>

    <!-- Ù…ÙˆØ±Ø¯ -->
    <div id="supplierBox" class="card p-3 mb-3 border-0 shadow-sm"
         style="{% if order.transaction_type == 'sale' %}display:none{% endif %}">
        <label class="form-label fw-bold">Ø§Ù„Ù…ÙˆØ±Ø¯</label>
        <div class="position-relative">
            <input type="text" id="supplierSearch" class="form-control"
                   value="{% if order.supplier %}{{ order.supplier.name }}{% endif %}"
                   placeholder="Ø§Ø¨Ø­Ø«..." autocomplete="off">
            <div id="supplierResults" class="list-group mt-1"></div>
        </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
    <div class="card border-0 shadow-sm p-0">
        <div class="table-responsive p-3">
            <table class="table table-bordered mb-0">
                <thead class="table-light">
                <tr>
                    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                    <th width="150">Ø§Ù„Ø³Ø¹Ø±</th>
                    <th width="100">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                    <th width="60">Ø­Ø°Ù</th>
                </tr>
                </thead>
                <tbody id="orderItems">
                {% for item in order.items.all %}
                <tr>
                    <td>
                        {{ item.product.name }}
                        <input type="hidden" name="product_id[]" value="{{ item.product.id }}">
                    </td>
                    <td>
                        <input type="number" name="price[]" step="0.01"
                               value="{{ item.price }}"
                               class="form-control price en-num"
                               oninput="calculateTotal()">
                    </td>
                    <td>
                        <input type="number" name="quantity[]" step="0.01" min="0.01"
                               value="{{ item.quantity }}"
                               class="form-control quantity en-num"
                               oninput="calculateTotal()">
                    </td>
                    <td class="subtotal fw-bold en-num">{{ item.subtotal }}</td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm"
                                onclick="this.closest('tr').remove(); calculateTotal()">Ã—</button>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <hr class="m-0">

        <div class="p-3">
            <div class="row g-3">
                <div class="col-md-4">
                    <label>Ø§Ù„Ø­Ø³Ù…</label>
                    <input type="number" name="discount" step="0.01"
                           value="{{ order.discount }}"
                           class="form-control en-num"
                           oninput="calculateTotal()">
                </div>

                <div class="col-md-4">
                    <label>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
                    <input type="number" name="payment" step="0.01"
                           value="{{ order.payment }}"
                           class="form-control en-num">
                </div>

                <div class="col-md-4">
                    <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</label>
                    <input type="text" id="totalDisplay" readonly
                           class="form-control fw-bold fs-5 text-success en-num"
                           value="{{ order.items_total }}">
                </div>
            </div>

            <button class="btn btn-primary mt-4">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.querySelector("form");
        if (!form) return;

        form.addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
                const tag = e.target.tagName.toLowerCase();
                if (tag !== "textarea") {
                    e.preventDefault();
                }
            }
        });
    });
    </script>
</form>

</div>

<script>
/* Ø³Ù‡Ù… Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± */
const sidebar = document.getElementById("sidebar");
const arrow   = document.getElementById("sidebarArrow");

arrow.onclick = () => {
    sidebar.classList.toggle("active");
    arrow.innerHTML = sidebar.classList.contains("active") ? "â®" : "â¯";
};

/* Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙØ­Ø© ÙƒÙ…Ø§ Ù‡Ùˆ */
function toggleFields(){
    let t = document.getElementById("transaction_type").value;
    document.getElementById("transaction_type_hidden").value = t;
    document.getElementById("customerBox").style.display = t === "sale" ? "block" : "none";
    document.getElementById("supplierBox").style.display = t === "purchase" ? "block" : "none";
}
toggleFields();

function calculateTotal(){
    let total = 0;
    document.querySelectorAll("#orderItems tr").forEach(row=>{
        let p = parseFloat(row.querySelector(".price").value)||0;
        let q = parseFloat(row.querySelector(".quantity").value)||0;
        let s = p*q;
        row.querySelector(".subtotal").innerText = s.toLocaleString();
        total+=s;
    });
    let d = parseFloat(document.querySelector("input[name='discount']").value)||0;
    document.getElementById("totalDisplay").value = (total-d).toLocaleString();
}
calculateTotal();
</script>

</body>
</html>
