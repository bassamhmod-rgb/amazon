{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ â€“ {{ store.name }}</title>

    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

    <style>
        body { background:#f7f9fc; font-family:"Cairo",sans-serif; overflow-x: hidden; }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .sidebar {
            width:230px; background:#fff; height:100vh; position:fixed; top:0; right:0;
            padding:20px 15px; border-left:1px solid #e0e0e0; z-index:1050; /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø·Ø¨Ù‚Ø§Øª */
            transition: right 0.3s ease;
        }
        .sidebar a {
            display:block; padding:10px 12px; margin-bottom:8px;
            color:#333; border-radius:8px; text-decoration:none;
        }
        .sidebar a:hover { background:#e9f2ff; color:#0d6efd; }
        
        .content { margin-right:240px; padding:20px; transition: margin-right 0.3s ease; }

        /* Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        @media (max-width:768px){
            .sidebar { right:-260px; }
            .sidebar.active { right:0; box-shadow: -5px 0 15px rgba(0,0,0,0.1); }
            .content { margin-right:0; }
            #toggleSidebar { display:inline-block !important; }
        }

        /* 4. ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø²Ø± Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
        #toggleSidebar {
            display:none; font-size:28px; background:none; border:none; margin-bottom:10px; cursor: pointer;
        }

        .table td, .table th { vertical-align: middle; }

        /* ØªØ­Ø³ÙŠÙ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
        #searchResults, #customerResults {
            max-height:200px; overflow-y:auto;
            box-shadow:0 4px 6px rgba(0,0,0,0.15);
            border: 1px solid #dee2e6;
        }

        /* Ø£Ø±Ù‚Ø§Ù… Ø¥Ù†ÙƒÙ„ÙŠØ²ÙŠØ© */
        .en-num { direction:ltr !important; unicode-bidi:plaintext !important; }
     .back-to-store-btn {
    background: #d1d5db;
    color: #111 !important;
    padding: 10px 18px;
    border-radius: 10px;
    border: none;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.back-to-store-btn:hover {
    background: #c5c9d0;
}

    </style>

</head>
<body>

<!-- Mobile toggle button -->
<button id="toggleSidebar">â˜°</button>
<!-- Sidebar -->
{% include "dashboard/sidebar.html" %}

<!-- Content -->
 <div class="content">

    <h3 class="mb-4">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù… #{{ order.id }}</h3>

    <div class="card p-3 mb-3 border-0 shadow-sm">
        <label class="form-label fw-bold">Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬</label>
        <div class="position-relative">
            <input type="text" id="productSearch" class="form-control" 
                   placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬..." autocomplete="off"
                   onkeydown="return event.key != 'Enter';">
            <div id="searchResults" class="list-group mt-1"
                 style="display:none; position:absolute; width:100%; z-index:1000; background:#fff;"></div>
        </div>
    </div>

    <div class="card p-3 mb-3 border-0 shadow-sm">
        <label class="form-label fw-bold">Ø§Ù„Ø²Ø¨ÙˆÙ†</label>

        <div id="customerSearchContainer" class="position-relative"
             style="{% if order.customer %}display:none{% endif %}">
            <input type="text" id="customerSearch" class="form-control"
                   placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø²Ø¨ÙˆÙ† (Ø§Ø³Ù…)..." autocomplete="off"
                   onkeydown="return event.key != 'Enter';">
            <div id="customerResults" class="list-group mt-1"
                 style="display:none; position:absolute; width:100%; z-index:1000; background:#fff;"></div>
        </div>

        <div id="selectedCustomerCard"
             class="alert alert-success d-flex justify-content-between align-items-center m-0"
             style="{% if order.customer %}display:flex{% else %}display:none{% endif %}">
            <div>
                <span class="fw-bold">ğŸ‘¤ Ø§Ù„Ø²Ø¨ÙˆÙ†:</span>
                <span id="selectedCustomerName" class="mx-2 text-dark">
                  {% if order.customer %}{{ order.customer }}{% endif %}
                </span>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger bg-white"
                    onclick="removeCustomer()">âŒ ØªØºÙŠÙŠØ±</button>
        </div>
    </div>

    <form method="post" id="orderForm">
        {% csrf_token %}

        <input type="hidden" name="customer_id" id="customer_id"
               value="{% if order.customer %}{{ order.customer.id }}{% endif %}" required>

        <div class="card border-0 shadow-sm p-3">

            <table class="table table-bordered table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th style="width:150px">Ø§Ù„Ø³Ø¹Ø±</th>
                        <th style="width:100px">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                        <th style="width:60px">Ø­Ø°Ù</th>
                    </tr>
                </thead>
                <tbody id="orderItems">

                    {% for item in order.items.all %}
                    <tr>
                        <td>
                            {{ item.product.name }}
                            <input type="hidden" name="product_id[]" value="{{ item.product.id }}">
                        </td>

                        <td>
                            <input type="number" name="price[]" value="{{ item.price }}"
                                   class="form-control price en-num" step="0.01" min="0"
                                   oninput="calculateTotal()">
                        </td>

                        <td>
                            <input type="number" name="quantity[]" value="{{ item.quantity }}"
                                   min="1" class="form-control quantity en-num"
                                   oninput="calculateTotal()">
                        </td>

                        <td class="subtotal fw-bold en-num">{{ item.subtotal }}</td>

                        <td>
                            <button type="button" class="btn btn-danger btn-sm"
                                    onclick="this.closest('tr').remove(); calculateTotal();">Ã—</button>
                        </td>
                    </tr>
                    {% endfor %}

                </tbody>
            </table>

            <hr>

            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Ø§Ù„Ø­Ø³Ù…</label>
                    <input type="number" step="0.01" min="0" name="discount"
                           value="{{ order.discount }}" class="form-control en-num"
                           oninput="calculateTotal()">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
                    <input type="number" step="0.01" min="0" name="payment"
                           value="{{ order.payment }}" class="form-control en-num">
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-bold">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</label>
                    <input type="text" id="totalDisplay"
                           class="form-control fw-bold fs-5 text-success en-num"
                           readonly value="{{ order.items_total }}">
                </div>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary px-4">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                <a href="{% url 'dashboard:orders_list' store.slug %}"
                   class="btn btn-secondary px-4">Ø¥Ù„ØºØ§Ø¡</a>
            </div>

        </div>
    </form>
</div>

<script>
/* Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
document.getElementById("toggleSidebar").onclick = function () {
    document.getElementById("sidebar").classList.toggle("active");
};

/* ===================== Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ===================== */
document.getElementById("productSearch").addEventListener("keyup", function () {
    let q = this.value;
    if (q.length < 1) {
        document.getElementById("searchResults").style.display = "none";
        return;
    }

    fetch(`/dashboard/{{ store.slug }}/search-products/?q=` + encodeURIComponent(q))
        .then(r => r.json())
        .then(data => {
            let box = document.getElementById("searchResults");
            box.innerHTML = "";
            if(data.results.length === 0){
                 // Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù†ØªØ§Ø¦Ø¬
                 box.innerHTML = '<div class="list-group-item text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
            } else {
                data.results.forEach(item => {
                    let a = document.createElement("a");
                    a.classList.add("list-group-item", "list-group-item-action");
                    a.style.cursor = "pointer";
                    a.innerText = item.name + " â€“ " + item.price + " $";
                    a.onclick = () => selectProduct(item);
                    box.appendChild(a);
                });
            }
            box.style.display = "block";
        });
});

/* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§ */
document.addEventListener('click', function(event) {
    const pBox = document.getElementById('searchResults');
    const pInput = document.getElementById('productSearch');
    if (!pBox.contains(event.target) && event.target !== pInput) {
        pBox.style.display = 'none';
    }
    
    const cBox = document.getElementById('customerResults');
    const cInput = document.getElementById('customerSearch');
    if (cBox && !cBox.contains(event.target) && event.target !== cInput) {
        cBox.style.display = 'none';
    }
});

/* Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ */
function selectProduct(item) {
    let tbody = document.getElementById("orderItems");
    
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - ÙŠÙ…ÙƒÙ† Ø¥Ø²Ø§Ù„ØªÙ‡ Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³Ù…Ø­ Ø¨Ø§Ù„ØªÙƒØ±Ø§Ø±)
    /*
    let exists = Array.from(tbody.querySelectorAll('input[name="product_id[]"]')).find(input => input.value == item.id);
    if(exists) {
        alert('Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
        return;
    }
    */

    let row = document.createElement("tr");

    row.innerHTML = `
        <td>${item.name}
            <input type="hidden" name="product_id[]" value="${item.id}">
        </td>
        <td><input type="number" name="price[]" value="${item.price}"
                   class="form-control price en-num" step="0.01" min="0"
                   oninput="calculateTotal()"></td>
        <td><input type="number" name="quantity[]" value="1"
                   min="1" class="form-control quantity en-num"
                   oninput="calculateTotal()"></td>
        <td class="subtotal fw-bold en-num">${parseFloat(item.price).toLocaleString()}</td>
        <td>
            <button type="button" class="btn btn-danger btn-sm"
                    onclick="this.closest('tr').remove(); calculateTotal();">Ã—</button>
        </td>
    `;

    tbody.appendChild(row);
    calculateTotal();

    document.getElementById("searchResults").style.display = "none";
    document.getElementById("productSearch").value = "";
    document.getElementById("productSearch").focus(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ÙƒÙŠØ² Ù„Ù„Ø¨Ø­Ø« Ø§Ù„ØªØ§Ù„ÙŠ
}

/* Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨ */
function calculateTotal() {
    let total = 0;

    document.querySelectorAll("#orderItems tr").forEach(row => {
        let price = parseFloat(row.querySelector(".price").value) || 0;
        let qty   = parseFloat(row.querySelector(".quantity").value) || 0;
        let sub   = price * qty;

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙØ±Ø¹ÙŠ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        row.querySelector(".subtotal").innerText = sub.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2});
        total += sub;
    });

    let discount = parseFloat(document.querySelector('input[name="discount"]').value) || 0;
    let finalTotal = total - discount;
    if(finalTotal < 0) finalTotal = 0;

    document.getElementById("totalDisplay").value = finalTotal.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2});
}

/* Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© â€“ Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¨Ø§Ø´Ø±Ø© */
window.addEventListener("load", calculateTotal);

/* ===================== Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø²Ø¨ÙˆÙ† ===================== */
document.getElementById("customerSearch")?.addEventListener("keyup", function () {
    let q = this.value;
    if (q.length < 1) {
        document.getElementById("customerResults").style.display = "none";
        return;
    }

    fetch(`/dashboard/{{ store.slug }}/search-customers/?q=` + encodeURIComponent(q))
        .then(r => r.json())
        .then(data => {
            let box = document.getElementById("customerResults");
            box.innerHTML = "";
            if(data.results.length === 0){
                 box.innerHTML = '<div class="list-group-item text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
            } else {
                data.results.forEach(item => {
                    let a = document.createElement("a");
                    a.classList.add("list-group-item", "list-group-item-action");
                    a.style.cursor = "pointer";
                    a.innerText = item.name;
                    a.onclick = () => selectCustomer(item);
                    box.appendChild(a);
                });
            }
            box.style.display = "block";
        });
});

/* Ø§Ø®ØªÙŠØ§Ø± Ø²Ø¨ÙˆÙ† */
function selectCustomer(item) {
    document.getElementById("customer_id").value = item.id;
    document.getElementById("selectedCustomerName").innerText = item.name;

    document.getElementById("customerSearchContainer").style.display = "none";
    document.getElementById("selectedCustomerCard").style.display = "flex";

    document.getElementById("customerResults").style.display = "none";
}

/* ØªØºÙŠÙŠØ±/Ø­Ø°Ù Ø§Ù„Ø²Ø¨ÙˆÙ† */
function removeCustomer() {
    document.getElementById("customer_id").value = "";
    document.getElementById("selectedCustomerCard").style.display = "none";
    document.getElementById("customerSearchContainer").style.display = "block";
    document.getElementById("customerSearch").value = "";
    document.getElementById("customerSearch").focus();
}
</script>

</body>
</html>