{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <title>Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ â€“ {{ store.name }}</title>
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

    <style>
        body { background:#f7f9fc; font-family:"Cairo",sans-serif; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .sidebar {
            width: 230px; background:#fff; height:100vh; position:fixed; top:0; right:0;
            padding:20px 15px; border-left:1px solid #e0e0e0; z-index: 999;
        }
        .sidebar a { display:block; padding:10px 12px; margin-bottom:8px; color:#333;
                     border-radius:8px; text-decoration:none; }
        .sidebar a:hover { background:#e9f2ff; color:#0d6efd; }
        .content { margin-right:240px; padding:20px; }
        
        /* Ø§Ù„ØªØ¬Ø§ÙˆØ¨ Ù…Ø¹ Ø§Ù„Ø¬ÙˆØ§Ù„ */
        @media (max-width:768px){
            .sidebar{ right:-260px; transition:.3s; }
            .sidebar.active{ right:0; }
            .content{ margin-right:0; }
            #toggleSidebar{ display:inline-block !important; }
        }
        #toggleSidebar{ display:none; font-size:28px; background:none; border:none; margin-bottom:10px; }

        .table td, .table th { vertical-align: middle; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
        #searchResults, #customerResults { max-height: 200px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .back-to-store-btn {
    background: #d1d5db;
    color: #111 !important;
    padding: 10px 18px;
    border-radius: 10px;
    border: none;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.back-to-store-btn:hover {
    background: #c5c9d0;
}

    </style>

</head>
<body>

<!-- Mobile toggle button -->
<button id="toggleSidebar">â˜°</button>
<!-- Sidebar -->
{% include "dashboard/sidebar.html" %}

<!-- Content -->
 <div class="content">
    <h3 class="mb-4">Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>

    <div class="card p-3 mb-3 border-0 shadow-sm">
        <label class="form-label fw-bold">Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬</label>
        <div class="position-relative">
            <input type="text" id="productSearch" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬...">
            <div id="searchResults" class="list-group mt-1" style="display:none; position:absolute; width:100%; z-index:1000;"></div>
        </div>
    </div>

    <div class="card p-3 mb-3 border-0 shadow-sm">
        <label class="form-label fw-bold">Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
        
        <div id="customerSearchContainer" class="position-relative">
            <input type="text" id="customerSearch" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø²Ø¨ÙˆÙ† Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…...">
            <div id="customerResults" class="list-group mt-1" style="display:none; position:absolute; width:100%; z-index:1000;"></div>
        </div>

        <div id="selectedCustomerCard" class="alert alert-success d-flex justify-content-between align-items-center m-0" style="display:none !important;">
            <div>
                <span class="fw-bold">ğŸ‘¤ Ø§Ù„Ø²Ø¨ÙˆÙ†:</span>
                <span id="selectedCustomerName" class="mx-2 text-dark"></span>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger bg-white" onclick="removeCustomer()">âŒ ØªØºÙŠÙŠØ±</button>
        </div>
    </div>

    <form method="post">
        {% csrf_token %}

        <input type="hidden" name="customer_id" id="customer_id" required>

        <div class="card border-0 shadow-sm p-3">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th width="150">Ø§Ù„Ø³Ø¹Ø±</th>
                        <th width="100">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                        <th>Ø­Ø°Ù</th>
                    </tr>
                </thead>
                <tbody id="orderItems">
                    </tbody>
            </table>

            <hr>

            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Ø§Ù„Ø­Ø³Ù…</label>
                    <input type="number" step="0.01" name="discount" class="form-control" value="0" oninput="calculateTotal()">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
                    <input type="number" step="0.01" name="payment" class="form-control" value="0">
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</label>
                    <input type="text" id="totalDisplay" class="form-control fw-bold fs-5 text-success" readonly value="0">
                </div>
            </div>

            <div class="mt-4">
                <button class="btn btn-primary px-4">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨</button>
                <a href="{% url 'dashboard:orders_list' store.slug %}" class="btn btn-secondary px-4">Ø¥Ù„ØºØ§Ø¡</a>
            </div>
        </div>
    </form>
</div>

<script>
// === 1. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ===
document.getElementById("toggleSidebar").onclick = function() {
    document.getElementById("sidebar").classList.toggle("active");
}

// === 2. Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ===

// Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
document.getElementById("productSearch").addEventListener("keyup", function() {
    let query = this.value;
    if (query.length < 1) {
        document.getElementById("searchResults").style.display = "none";
        return;
    }
    fetch(`/dashboard/{{ store.slug }}/search-products/?q=` + query)
        .then(response => response.json())
        .then(data => {
            let box = document.getElementById("searchResults");
            box.innerHTML = "";
            data.results.forEach(item => {
                let option = document.createElement("a");
                option.classList.add("list-group-item", "list-group-item-action");
                option.style.cursor = "pointer";
                option.innerText = item.name + " â€“ " + item.price + " $";
                option.onclick = () => selectProduct(item);
                box.appendChild(option);
            });
            box.style.display = "block";
        });
});

// Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ù„Ø¬Ø¯ÙˆÙ„
function selectProduct(item) {
    let tbody = document.getElementById("orderItems");
    let row = document.createElement("tr");

    row.innerHTML = `
        <td>
            ${item.name}
            <input type="hidden" name="product_id[]" value="${item.id}">
        </td>
        <td>
            <input type="number" name="price[]" value="${item.price}" class="form-control price" oninput="calculateTotal()">
        </td>
        <td>
            <input type="number" name="quantity[]" value="1" min="1" class="form-control quantity" oninput="calculateTotal()">
        </td>
        <td class="subtotal fw-bold">${item.price}</td>
        <td>
            <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); calculateTotal();">Ã—</button>
        </td>
    `;

    tbody.appendChild(row);
    calculateTotal();
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØªÙØ±ÙŠØº Ø§Ù„Ø¨Ø­Ø«
    document.getElementById("searchResults").style.display = "none";
    document.getElementById("productSearch").value = "";
    document.getElementById("productSearch").focus();
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹
function calculateTotal() {
    let total = 0;
    document.querySelectorAll("#orderItems tr").forEach(row => {
        let price = parseFloat(row.querySelector(".price").value) || 0;
        let qty   = parseFloat(row.querySelector(".quantity").value) || 0;
        let sub   = price * qty;
        row.querySelector(".subtotal").innerText = sub.toLocaleString(); // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ù‚Ù…
        total += sub;
    });

    let discountInput = document.querySelector('input[name="discount"]');
    let discount = parseFloat(discountInput ? discountInput.value : 0) || 0;

    document.getElementById("totalDisplay").value = (total - discount).toLocaleString();
}


// === 3. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† (Ø§Ù„Ø¬Ø¯ÙŠØ¯) ===

// Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø²Ø¨ÙˆÙ†
document.getElementById("customerSearch").addEventListener("keyup", function () {
    let query = this.value;
    if (query.length < 1) {
        document.getElementById("customerResults").style.display = "none";
        return;
    }
    fetch(`/dashboard/{{ store.slug }}/search-customers/?q=` + query)
        .then(response => response.json())
        .then(data => {
            let box = document.getElementById("customerResults");
            box.innerHTML = "";
            data.results.forEach(item => {
                let option = document.createElement("a");
                option.classList.add("list-group-item", "list-group-item-action");
                option.style.cursor = "pointer";
                option.innerText = item.name + " â€“ " + item.phone;
                option.onclick = () => selectCustomer(item);
                box.appendChild(option);
            });
            box.style.display = "block";
        });
});

// Ø§Ø®ØªÙŠØ§Ø± Ø²Ø¨ÙˆÙ†
function selectCustomer(item) {
    // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù€ ID
    document.getElementById("customer_id").value = item.id;
    
    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
    document.getElementById("selectedCustomerName").innerText = item.name + " (" + item.phone + ")";
    
    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ (Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø­Ø« ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©)
    document.getElementById("customerSearchContainer").style.display = "none";
    document.getElementById("selectedCustomerCard").style.setProperty("display", "flex", "important");
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    document.getElementById("customerResults").style.display = "none";
    document.getElementById("customerSearch").value = "";
}

// Ø­Ø°Ù/ØªØºÙŠÙŠØ± Ø§Ù„Ø²Ø¨ÙˆÙ†
function removeCustomer() {
    // ØªÙØ±ÙŠØº Ø§Ù„Ù€ ID
    document.getElementById("customer_id").value = "";
    
    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ (Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨Ø­Ø«)
    document.getElementById("selectedCustomerCard").style.setProperty("display", "none", "important");
    document.getElementById("customerSearchContainer").style.display = "block";
    
    // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø«
    document.getElementById("customerSearch").focus();
}
</script>

</body>
</html>